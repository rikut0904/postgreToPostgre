# PostgreSQL → PostgreSQL データ移行ツール

## 概要
任意の PostgreSQL データベースから別の PostgreSQL データベースへ、Web UI を通じてデータを移行するツール。接続情報を UI 上で指定するだけで、特定のプロダクトに依存せずに汎用的に利用できる。

## 技術スタック
- バックエンド: Go (net/http + gorilla/websocket)
- フロントエンド: HTML / CSS / JavaScript
- DB ドライバ: lib/pq または pgx
- リアルタイム通信: WebSocket

## 機能

### 接続管理
- 移行元（Source）と移行先（Destination）の接続情報を UI 上で入力できる。
- 「テスト接続」ボタンで疎通確認を行う。

### スキーマブラウジング
- 接続成功後、移行元 DB の構成をツリー形式で表示する。
- スキーマ配下のテーブル、ビュー、関数、シーケンス、トリガーを一覧化する。

### 移行対象の選択
- スキーマ単位、テーブル単位、オブジェクト種別単位で移行対象を選べる。
- チェックボックスでの選択と「全選択 / 全解除」に対応する。

### 移行オプション
- 既存テーブルの扱い、既存データの扱い、バッチサイズ、並行ワーカー数などを実行前に設定できる。
- FK 制約を移行中に無効化する設定が可能。
- 実行モードとドライラン（書き込みなし）を切り替えできる。

### 移行対象オブジェクト（フル移行）
- スキーマ、型、シーケンス、テーブル、データ、インデックス、制約、ビュー、関数/プロシージャ、トリガーの順で移行する。
- 依存関係を考慮した順序制御を行う。

### 並行処理
- goroutine ワーカープールによるテーブル単位の並行データコピー。
- インデックス・制約の作成も並行処理。
- ワーカー数は自動調整（min(テーブル数, 8)）または手動指定。
- 各ワーカーが独自の DB 接続を保持し、テーブル単位トランザクションで実行。

### 大規模データ対応
- 指定バッチサイズで分割して INSERT/COPY を実行する。
- 進捗率、処理行数、経過時間を WebSocket でリアルタイム表示する。
- テーブル別の進捗を表示する。
- 中断ボタンで安全に停止できる（現在バッチ完了後に停止）。
- 移行ログを UI に表示し、ファイルにも出力する。

### エラーハンドリング
- 接続エラー時は移行を停止し、エラーメッセージを表示する。
- テーブル単位でエラーを捕捉し、失敗テーブルを記録して他のテーブルの移行は続行する。
- 失敗したテーブルはエラー内容付きで UI に一覧表示される。
- スキーマ不整合は検証フェーズで警告を表示する。

## 画面構成
- 1 ページ構成のステップ形式。
- Step 1: 接続設定
- Step 2: 移行対象選択
- Step 3: 移行オプション
- Step 4: 実行・進捗

## API

### REST
- POST `/api/test-connection`: 接続テスト
- POST `/api/browse`: 移行元 DB のスキーマ・テーブル一覧取得
- POST `/api/table-info`: テーブル詳細情報取得
- POST `/api/migrate`: 移行開始
- POST `/api/migrate/cancel`: 移行中断
- GET `/api/migrate/status`: 移行状態取得

### WebSocket
- `/ws/progress`: 進捗のリアルタイム通知

## ディレクトリ構成
```
postgreToPostgre/
├── main.go
├── go.mod
├── go.sum
├── docs/
│   ├── SPEC.md
│   └── ABOUT.md
├── internal/
│   ├── server/
│   ├── migration/
│   ├── database/
│   └── websocket/
└── web/
    ├── index.html
    ├── css/
    └── js/
```
